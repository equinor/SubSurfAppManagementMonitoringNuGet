## SubsurfAppManagementMonitoringNuget

## About

This Repository is a nuget package responsible standardizing HVS (Health Vulnerability and security) for subsurface applications. The package is hosted in the [github registry](https://github.com/orgs/equinor/packages?repo_name=SubSurfAppManagementMonitoringNuGet).

[github nuget registry documentation](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-nuget-registry)

## Setup

### Personal access token

The personal access token is used in place of password when pulling/pushing nuget packages with github.

#### Generate personal access token in github
**Note:** This only applies if you haven't got a PAT token with the permissions as listed below with authorization to Equinor. If you do then feel free to you that one instead of creating another one.

settings -> developer settings -> personal access token -> Tokens (classic) -> generate new classic token and select the package read premissions.

then configure SSO and authorize it for equinor.

### Adding github to your nuget sources

to equinors github as a nuget source with the dotnet cli run:
```
dotnet nuget add source https://nuget.pkg.github.com/equinor/index.json -n equinor -u GITHUB_USERNAME -p PERSONAL_ACCESS_TOKEN --store-password-in-clear-text
```
Replace PERSONAL_ACCESS_TOKEN with the value of your personal access token, generated by GitHub.
Replace GITHUB_USERNAME with your GitHub username.


## Uploading new version of the nuget package

In the github repository, Click Create new release. Create a tag in the fromat `v#.#.#`, where `#` are one or more numbers. Upon publishing the release Github actions will pack and upload a new package with version `v#.#.#`.


#### Preview Release

To make a preview release create a release with a tag in the following format `v#.#.#-preview#.#.#`.

### Dockerfile

In the dockerfile Make sure to add the nuget source before runnning `dotnet restore`.
`GIT_USER` is your github username, and `GIT_TOKEN_NUGET_READ` is your github classic token with at least nuget read premissions.
like shown below you also need to decode from base64 because thats how [radix passes build secrets](https://www.radix.equinor.com/guides/build-secrets/#build-secrets).

```
# ADD nuget source
ARG GIT_TOKEN_NUGET_READ
ARG GIT_USER
RUN TOKEN=$(echo $GIT_TOKEN_NUGET_READ|base64 -d) && \
USER=$(echo $GIT_USER|base64 -d) && \
dotnet nuget add source https://nuget.pkg.github.com/equinor/index.json -n equinor -u $USER -p $TOKEN --store-password-in-clear-text
```


### Radix Configuration
You will need to declere `GIT_USER` and `GIT_TOKEN_NUGET_READ` as build secrets in the radixconfig.yaml

```
apiVersion: radix.equinor.com/v1
kind: RadixApplication
metadata:
  name: ...
spec:
  build:
    secrets:
      - GIT_TOKEN_NUGET_READ
      - GIT_USER
  environments:
  ...
```
